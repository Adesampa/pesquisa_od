---
title: "Untitled"
output: html_document
date: "2025-02-12"
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(global.par = TRUE)
knitr::opts_knit$set(globalenv = TRUE)

(knitr::opts_chunk$set(
	echo = FALSE,
	error = FALSE,
	message = FALSE,
	warning = FALSE))

```

```{r}

library("ggpubr")
library("tidyverse")
library("kableExtra")
library("knitr")
library("tidylog")
library("readxl")
library("geobr")
library("sf")
library("wesanderson")
library("ggplot2")
library("stringr")
library ("abjData")
library("extrafont")
library("lubridate")
library("transformr")
library("reactable")
library("rnaturalearth")
library("plotly")
library("ggrepel")
library('googlesheets4')
library("leaflet")
library('ggthemes')
library('rmdformats')
library("janitor")
library("reactablefmtr")
library("corrplot")
library("lubridate")
library("janitor")
library("ggmap")
library("stringr")
library("stringi")
library("ggthemes")
library("ggiraph")
library("patchwork")
library("showtext")
library("htmltools")
library("gganimate")
library("gifski")
library("av")
library("scales")
library("png")
library("magick")
library("ggtext")
library("waffle")
library("MetBrewer")
library("dplyr")
library("glue")
library("marquee")
library("geobr")
library("readr")

```


```{r}

# Definição de caminhos para evitar repetição
base_path <- "C:/Users/Thais Pereira/Documents/pesquisa_od/"
shape_path <- file.path(base_path, "Shape")
excel_path <- file.path(base_path, "Tabelas_Site_OD2023_070225.xlsx")

# Leitura de arquivos shapefile
shapes <- list(
  zona = st_read(file.path(shape_path, "Zonas_2023.shp"), options = "ENCODING=latin1"),
  distrito = st_read(file.path(shape_path, "Distritos_2023_region.shp"), options = "ENCODING=latin1"),
  municipio = st_read(file.path(shape_path, "Municipios_2023.shp"), options = "ENCODING=latin1")
)

# Leitura de arquivos Excel
pop_informalidade <- list(
  zona_residencia = read_excel(excel_path, sheet = 8, skip = 8),
  zona_emprego = read_excel(excel_path, sheet = 13, skip = 7)
)

# Renomeação de colunas
nomes_residencia <- c("Zona", "Assalariado_Carteira", "Assalariado_Sem_Carteira", 
                      "Funcionario_Publico", "Profissional_Liberal", "Autonomo_com_CNPJ", 
                      "Autonomo_sem_CNPJ", "Empregador", "Dono_Negocio_Familiar", 
                      "Trabalhador_Familiar", "Total")

nomes_emprego <- c("Zona", "Assalariado_Carteira", "Assalariado_Sem_Carteira", 
                   "Funcionario_Publico", "Profissional_Liberal", "Autonomo", 
                   "Empregador", "Dono_Negocio_Familiar", "Trabalhador_Familiar", 
                   "Total_empregos")

# Processamento dos dados de informalidade por zona de residência
informalidade <- pop_informalidade$zona_residencia %>%
  set_names(nomes_residencia) %>%
  slice(-c(1, (n()-6):n())) %>%
  mutate(across(where(is.numeric), round, 0),
         Informalidade = Assalariado_Sem_Carteira + Autonomo_sem_CNPJ,
         total_formal_informal = Total) %>%
  select(Zona, Informalidade, total_formal_informal)

# Processamento dos dados de emprego formal por zona de emprego
emprego_formal <- pop_informalidade$zona_emprego %>%
  set_names(nomes_emprego) %>%
  slice(-c(1, (n()-6):n())) %>%
  mutate(across(where(is.numeric), round, 0),
         empregos_formais = Assalariado_Carteira + Funcionario_Publico + 
                            Profissional_Liberal + Empregador + Dono_Negocio_Familiar) %>%
  select(Zona, empregos_formais, Total_empregos)

# Ajuste dos dataframes espaciais
shapes_distrito <- shapes$distrito %>%
  rename(geometry_distrito = geometry, NumDistrit = NumeroDist) %>%
  select(NumDistrit, geometry_distrito)

shapes_municipio <- shapes$municipio %>%
  rename(geometry_municipio = geometry, NumeroMuni = NumeroMuni) %>%
  select(NumeroMuni, geometry_municipio)

# Junção final dos dados espaciais
dados <- shapes$zona %>% 
  as.data.frame() %>% 
  rename(geometry_zona = geometry, Zona = NumeroZona) %>%
  select(-Area_ha_2) %>%
  mutate(Zona = as.character(Zona)) %>%
  left_join(shapes_distrito, by = "NumDistrit") %>%
  left_join(shapes_municipio, by = "NumeroMuni") %>%
  left_join(informalidade, by = "Zona") %>%
  left_join(emprego_formal, by = "Zona") %>% 
  mutate(across(everything(), ~ replace_na(.x, 0)))

write.csv(dados, "dados_od")

```



```{r}

# Funções 

# tabela com taxa de informalidade por zona de residência

dados %>% 
  mutate(tx_informalidade = Informalidade/total_formal_informal*100) %>% 
  select(NomeZona, geometry_zona, Informalidade, total_formal_informal, tx_informalidade) %>% 
  arrange(- tx_informalidade)


# tabela com taxa de informalidade por zona de distrito

dados %>% 
  group_by(NomeDistri, geometry_distrito) %>% 
  summarise(Informalidade = sum(Informalidade), 
            total_formal_informal = sum(total_formal_informal)) %>% 
  mutate(tx_informalidade = Informalidade/total_formal_informal*100) %>% 
  arrange(- tx_informalidade)

# tabela com taxa de informalidade por zona de municipio

dados %>% 
  group_by(NomeMunici, geometry_municipio) %>% 
  summarise(Informalidade = sum(Informalidade), 
            total_formal_informal = sum(total_formal_informal)) %>% 
  mutate(tx_informalidade = Informalidade/total_formal_informal*100) %>% 
  arrange(- tx_informalidade)



```
















